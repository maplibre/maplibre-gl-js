<!DOCTYPE html>
<html lang="en">
    <head>
        <title>global-state expression</title>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <link
            rel="stylesheet"
            href="../../dist//maplibre-gl.css"
        />
        <script src="../../dist/maplibre-gl-dev.js"></script>
        <style>
            body {
                margin: 0;
                padding: 0;
            }

            html,
            body,
            #map {
                height: 100%;
            }
        </style>
    </head>

    <body>
        <div id="map"></div>

        <script>
            const polygonSource = {
                type: "geojson",
                data: {
                    type: "Feature",
                    properties: {
                        category: "polygon",
                        featureProperty: "opacity",
                    },
                    geometry: {
                        coordinates: [
                            [
                                [-50, 50],
                                [-50, -50],
                                [50, -50],
                                [50, 50],
                                [-50, 50],
                            ],
                        ],
                        type: "Polygon",
                    },
                },
            };

            const pointSource = {
                type: "geojson",
                data: {
                    type: "Feature",
                    geometry: {
                        type: "Point",
                        coordinates: [0, 0],
                    },
                    properties: {
                        text: "Hello world!",
                    },
                },
            };

            const map = new maplibregl.Map({
                container: "map",
                style: {
                    version: 8,
                    glyphs: "https://demotiles.maplibre.org/font/{fontstack}/{range}.pbf",
                    sources: {
                        polygon: polygonSource,
                        point: pointSource,
                    },
                    state: {
                        // commented out to test what happens when the state is not set
                        // backgroundColor: {
                        //     default: "blue",
                        // },
                        textColor: {
                            default: "yellow",
                        },
                        fillColor: {
                            default: "green",
                        },
                        fillExtrusionColor: {
                            default: "purple",
                        },
                        lineColor: {
                            default: "red",
                        },
                        circleColor: {
                            default: "blue",
                        },
                        showFill: {
                            default: true,
                        },
                        showFillExtrusion: {
                            default: true,
                        },
                        showCircle: {
                            default: true,
                        },
                        showLine: {
                            default: true,
                        },
                        showSymbol: {
                            default: true,
                        }
                    },
                    layers: [
                        {
                            id: "background",
                            type: "background",
                            paint: {
                                "background-color": ["global-state", "backgroundColor"],
                            },
                        },
                        {
                            id: "fill",
                            type: "fill",
                            filter: ["global-state", "showFill"],
                            source: "polygon",
                            paint: {
                                "fill-color": ["global-state", "fillColor"],
                            },
                        },
                        {
                            id: 'fill-extrusion',
                            type: 'fill-extrusion',
                            source: 'polygon',
                            filter: ["global-state", "showFillExtrusion"],
                            paint: {
                                "fill-extrusion-color": ["global-state", "fillExtrusionColor"],
                                "fill-extrusion-height": 10000000,
                                "fill-extrusion-base": 0,
                                "fill-extrusion-opacity": 0.3,
                            }
                        },
                        {
                            id: "line",
                            type: "line",
                            source: "polygon",
                            filter: ["global-state", "showLine"],
                            paint: {
                                "line-color": ["global-state", "lineColor"],
                                "line-width": 2,
                            },
                        },
                        {
                            id: "circle",
                            type: "circle",
                            source: "point",
                            filter: ["global-state", "showCircle"],
                            paint: {
                                "circle-color": ["global-state", "circleColor"],
                                "circle-radius": 16,
                            },
                        },
                        {
                            id: "symbol",
                            type: "symbol",
                            source: "point",
                            filter: ["global-state", "showSymbol"],
                            paint: {
                                "text-color": ["global-state", "textColor"],
                            },
                            layout: {
                                "text-size": ["global-state", "size"],
                                "text-field": "{text}",
                            },
                        },
                    ],
                },
                center: [0, 0],
                zoom: 0,
            });

            map.on('data', (e) => {
              if (e.dataType === 'source') {
                console.log('(re)loaded source', e.sourceId);
              }
            });
            window.map = map;

            // usage
            // map.once("load", () => {
                // map.setGlobalStateProperty("bgcolor", "red");
            // });

            // test cases: setGlobalStateProperty(key)
            // should not reload sources when global-state key is used only in paint properties
            // should reload sources of the layers that use global-state key in filter
            // should not reload sources when new value is the same as the old one
            // should do nothing if property using global-state was changed with setFilter/setPaintProperty and no longer use global-state
        </script>
    </body>
</html>
