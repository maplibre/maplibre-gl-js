<!DOCTYPE html>
<html lang='en'>
<head>
    <title>Allow underzoom of single-copy world</title>
    <meta property='og:description' content='Allow a map to be zoomed out to show its entire bounded area with setAllowUnderzoom.' />
    <meta charset='utf-8'>
    <meta name='viewport' content='width=device-width, initial-scale=1'>
    <link rel='stylesheet' href='../../dist/maplibre-gl.css' />
    <script src='../../dist/maplibre-gl-dev.js'></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            background: repeating-conic-gradient(#000 0 25%, #444 0 50%) 50% / 32px 32px;
        }
        html, body, #map { height: 100%; }
        .listing-group {
            font-family: 'Helvetica Neue', Arial, Helvetica, sans-serif;
            position: absolute;
            top: 10px;
            left: 10px;
            background-color: #fff;
            padding: 10px;
            border-radius: 4px;
        }
    </style>
</head>
<body>
<div id='map'></div>
<table id='listing-group-bottom-left' class='listing-group'>
    <tr><td><label for='allow-underzoom'>allowUnderzoom</label></td><td><input type='checkbox' id='allow-underzoom' checked/></td></tr>
    <tr><td><label for='underzoom-slider' id='underzoom-label'>underzoom</label></td><td><input type='range' id='underzoom-slider' min='0' max='100' step='10' value='80' /></td></tr>
    <tr><td><label for='overpan-slider' id='overpan-label'>overpan</label></td><td><input type='range' id='overpan-slider' min='0' max='50' step='10' value='0' /></td></tr>
    <tr><td><label for='max-bounds-select'>maxBounds</label></td>
        <td><select name="max-bounds-select" id="max-bounds-select">
            <option value="undefined">World (undefined)</option>
            <option value="wide">NYC (wide)</option>
            <option value="tall">Amsterdam (tall)</option>
        </select></td>
    </tr>
</table>

<script>
    
    const map = new maplibregl.Map({
        container: 'map',
        renderWorldCopies: false,
        allowUnderzoom: true,
        underzoom: 80,
        overpan: 0,
        style: 'https://api.maptiler.com/maps/streets/style.json?key=get_your_own_OpIi9ZULNHzrESv6T2vL'
    });
    
    // New York, New York
    const w_north = 40.78;
    const w_east = -73.81;
    const w_south = 40.68;
    const w_west = -74.15;
    const w_bounds = [[w_west, w_south], [w_east, w_north]];
    const w_center = [(w_west + w_east) / 2, (w_north + w_south) / 2]

    // Amsterdam, Netherlands
    const t_north = 52.3676 + 0.5;
    const t_east = 4.9041 + 0.25;
    const t_south = 52.3676 - 0.5;
    const t_west = 4.9041 - 0.25;
    const t_bounds = [[t_west, t_south], [t_east, t_north]];
    const t_center = [(t_west + t_east) / 2, (t_north + t_south) / 2]

    const bounds_options = {
        "undefined": {
            "bounds": undefined, "center": [0, 0]
        },
        "wide": {
            "bounds": w_bounds, "center": w_center
        },
        "tall": {
            "bounds": t_bounds, "center": t_center
        },
    }

    const zeroPad = (num, places) => String(num).padStart(places, '0');
    function setUnderzoomFromUi() {
        map.setAllowUnderzoom(
            document.getElementById('allow-underzoom').checked
        );
        const underzoom = parseFloat(document.getElementById('underzoom-slider').value);
        map.setUnderzoom(underzoom);
        document.getElementById('underzoom-label').textContent = `underzoom (${zeroPad(underzoom, 3)}%)`;
        map.setZoom(-Infinity);
    }
    function setOverpanFromUi() {
        const overpan = parseFloat(document.getElementById('overpan-slider').value);
        map.setOverpan(overpan);
        document.getElementById('overpan-label').textContent = `overpan (${zeroPad(overpan, 2)}%)`;
    }
    function selectMaxBoundsFromUi() {
        const option = document.getElementById('max-bounds-select').value;
        map.setMaxBounds(bounds_options[option].bounds);
        map.setCenter(bounds_options[option].center);
        map.setZoom(-Infinity);
    }

    map.on('load', () => {
        map.addSource('bounds-wide', {
            'type': 'geojson',
            'data': {
                'type': 'Feature',
                'properties': {},
                'geometry': {
                    'type': 'LineString',
                    'coordinates': [
                        [w_west, w_south],
                        [w_west, w_north],
                        [w_east, w_north],
                        [w_east, w_south],
                        [w_west, w_south],
                    ]
                }
            }
        });
        map.addLayer({
            'id': 'bounds-wide',
            'type': 'line',
            'source': 'bounds-wide',
            'paint': {
                'line-color': '#ff0000',
                'line-width': 4,
                'line-offset': -2,
            }
        });
        map.addSource('bounds-tall', {
            'type': 'geojson',
            'data': {
                'type': 'Feature',
                'properties': {},
                'geometry': {
                    'type': 'LineString',
                    'coordinates': [
                        [t_west, t_south],
                        [t_west, t_north],
                        [t_east, t_north],
                        [t_east, t_south],
                        [t_west, t_south],
                    ]
                }
            }
        });
        map.addLayer({
            'id': 'bounds-tall',
            'type': 'line',
            'source': 'bounds-tall',
            'paint': {
                'line-color': '#ff0000',
                'line-width': 4,
                'line-offset': -2,
            }
        });
        document.getElementById('allow-underzoom').addEventListener('change', setUnderzoomFromUi);
        document.getElementById('underzoom-slider').addEventListener('input', setUnderzoomFromUi);
        document.getElementById('overpan-slider').addEventListener('input', setOverpanFromUi);
        document.getElementById('max-bounds-select').addEventListener('change', selectMaxBoundsFromUi);
        setUnderzoomFromUi();
        setOverpanFromUi();
        selectMaxBoundsFromUi();
    });
</script>
</body>
</html>