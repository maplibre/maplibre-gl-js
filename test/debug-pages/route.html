<!DOCTYPE html>
<html>
<head>
   <title>MapLibre GL JS debug page for terrian</title>
   <meta charset='utf-8'>
   <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
   <link rel='stylesheet' href='../../dist/maplibre-gl.css' />
   <style>
      body {
         margin: 0;
         padding: 0;
      }

      html,
      body,
      #map {
         height: 100%;
      }
   </style>
</head>

<body>
   <div id='map'></div>

   <script src='../../dist/maplibre-gl-dev.js'></script>
   <script src="https://unpkg.com/@turf/turf@6/turf.min.js"></script>
   <script>
      var coordinates = [[11.308599277574416, 47.37572663439167], [11.30782, 47.37554], [11.30761, 47.37551], [11.30754, 47.37532], [11.30755, 47.37508], [11.30752, 47.37501], [11.30691, 47.37478], [11.30686, 47.37469], [11.30689, 47.37456], [11.30701, 47.37448], [11.30754, 47.37445], [11.30761, 47.37449], [11.30767, 47.37462], [11.30777, 47.37466], [11.30794, 47.37468], [11.30805, 47.37471], [11.30849, 47.37474], [11.30872, 47.37473], [11.30881, 47.37472], [11.30896, 47.37459], [11.30902, 47.37452], [11.30905, 47.37443], [11.30913, 47.37433], [11.30915, 47.37423], [11.30912, 47.37408], [11.30917, 47.37394], [11.30914, 47.37389], [11.30907, 47.37384], [11.30909, 47.37382], [11.30913, 47.37382], [11.30958, 47.37392], [11.30979, 47.37401], [11.30985, 47.37398], [11.30982, 47.37387], [11.30976, 47.37378], [11.30964, 47.37369], [11.30923, 47.37351], [11.30924, 47.37348], [11.30945, 47.37346], [11.3096, 47.37347], [11.30982, 47.37354], [11.30997, 47.37356], [11.31016, 47.37358], [11.31019, 47.37356], [11.31019, 47.37353], [11.30996, 47.37344], [11.30983, 47.37326], [11.30956, 47.37309], [11.30941, 47.37292], [11.30931, 47.37272], [11.30932, 47.37262], [11.30943, 47.37241], [11.3095, 47.37235], [11.30993, 47.37213], [11.31024, 47.37193], [11.31032, 47.37192], [11.3104, 47.37194], [11.31091, 47.37234], [11.31114, 47.37211], [11.31121, 47.3719], [11.31118, 47.37134], [11.31126, 47.3711], [11.31147, 47.37079], [11.31147, 47.37064], [11.3114, 47.37045], [11.31114, 47.37009], [11.31114, 47.36988], [11.31122, 47.3697], [11.31139, 47.36954], [11.31144, 47.36943], [11.31141, 47.36934], [11.3113, 47.36925], [11.31114, 47.36908], [11.31107, 47.36897], [11.31111, 47.3688], [11.31136, 47.3687], [11.31147, 47.36852], [11.31166, 47.36844], [11.31211, 47.36838], [11.31274, 47.36811], [11.31285, 47.36803], [11.31286, 47.36789], [11.31268, 47.36773], [11.31239, 47.36766], [11.31192, 47.36763], [11.31126, 47.36749], [11.31108, 47.3675], [11.31083, 47.36763], [11.31068, 47.36765], [11.31058, 47.36761], [11.31045, 47.36753], [11.31045, 47.36737], [11.31049, 47.36715], [11.31036, 47.36693], [11.31037, 47.36682], [11.31047, 47.36664], [11.31063, 47.36655], [11.31131, 47.36642], [11.31137, 47.36634], [11.31138, 47.36622], [11.31099, 47.36592], [11.31091, 47.36584], [11.31088, 47.36576], [11.31094, 47.36561], [11.31112, 47.3653], [11.31132, 47.36508], [11.31153, 47.36498], [11.31165, 47.36486], [11.31163, 47.36459], [11.31182, 47.36424], [11.31214, 47.36398], [11.31221, 47.36384], [11.31235, 47.36373], [11.31262, 47.36344], [11.31301, 47.3629], [11.31315, 47.3626], [11.31307, 47.36236], [11.31309, 47.36229], [11.31318, 47.36222], [11.31343, 47.36203], [11.31345, 47.36192], [11.3135, 47.36183], [11.31359, 47.3618], [11.31416, 47.36175], [11.31424, 47.36172], [11.31427, 47.36166], [11.3143, 47.36153], [11.31434, 47.36146], [11.31469, 47.36127], [11.31474, 47.36121], [11.31495, 47.36071], [11.31498, 47.36035], [11.31507, 47.36021], [11.31569, 47.35998], [11.31574, 47.35991], [11.3157, 47.35985], [11.31543, 47.35973], [11.31537, 47.35968], [11.31544, 47.35938], [11.31553, 47.35931], [11.31623, 47.35914], [11.3165, 47.35909], [11.31693, 47.35907], [11.31703, 47.35902], [11.31702, 47.35892], [11.31642, 47.35854], [11.31633, 47.35843], [11.31634, 47.35833], [11.31645, 47.35808], [11.31644, 47.35787], [11.31632, 47.3576], [11.31636, 47.35736], [11.31621, 47.35712], [11.3162, 47.35706], [11.31628, 47.35689], [11.3165, 47.35677], [11.31717, 47.35665], [11.3174, 47.35657], [11.31754, 47.35647], [11.3176, 47.35637], [11.31761, 47.35618], [11.31767, 47.35606], [11.31784, 47.35594], [11.31799, 47.35574], [11.31837, 47.35554], [11.31857, 47.35533], [11.31869, 47.35526], [11.31918, 47.35511], [11.31936, 47.35501], [11.32037, 47.3541], [11.32048, 47.35371], [11.32066, 47.35343], [11.32078, 47.35316], [11.32076, 47.35295], [11.32066, 47.35283], [11.32039, 47.35258], [11.32029, 47.35245], [11.32029, 47.35236], [11.3204, 47.35186], [11.3206, 47.3514], [11.32066, 47.35131], [11.32102, 47.35106], [11.32143, 47.35087], [11.3219, 47.35073], [11.32216, 47.3506], [11.32229, 47.35046], [11.32246, 47.35], [11.32267, 47.34958], [11.32275, 47.34948], [11.32315, 47.34919], [11.32343, 47.34868], [11.32366, 47.3482], [11.32378, 47.34809], [11.32394, 47.34803], [11.32421, 47.34795], [11.32439, 47.34783], [11.32454, 47.34753], [11.32473, 47.34725], [11.32548, 47.34672], [11.32619, 47.34639], [11.32652, 47.34605], [11.32666, 47.34595], [11.32701, 47.34582], [11.32737, 47.34553], [11.32763, 47.34539], [11.32801, 47.3453], [11.32873, 47.34489], [11.32923, 47.34469], [11.32947, 47.34455], [11.32969, 47.34437], [11.33012, 47.34391], [11.33032, 47.34372], [11.33183, 47.34282], [11.33233, 47.34264], [11.33269, 47.34232], [11.33288, 47.34232], [11.33373, 47.34202], [11.3343, 47.34163], [11.33469, 47.3413], [11.33485, 47.3412], [11.3349, 47.34112], [11.33494, 47.34086], [11.33509, 47.34065], [11.33523, 47.34053], [11.3353, 47.34051], [11.33544, 47.34055], [11.33544, 47.34061], [11.33539, 47.34072], [11.33525, 47.34086], [11.33524, 47.34091], [11.33526, 47.34096], [11.3354, 47.341], [11.33595, 47.34106], [11.33627, 47.34099], [11.33629, 47.34103], [11.33615, 47.34116], [11.336, 47.34128], [11.33598, 47.34135], [11.33605, 47.3414], [11.33615, 47.3414], [11.33636, 47.34132], [11.33643, 47.34135], [11.33677, 47.34091], [11.3372, 47.34062], [11.33776, 47.33999], [11.33795, 47.33989], [11.33919, 47.33974], [11.3395, 47.33956], [11.33973, 47.33916], [11.34007, 47.339], [11.34081, 47.33855], [11.34113, 47.33841], [11.34133, 47.33841], [11.34202, 47.33824], [11.34268, 47.33814], [11.3429, 47.33808], [11.34315, 47.33797], [11.34337, 47.33781], [11.34356, 47.33737], [11.34386, 47.33679], [11.34424, 47.33645], [11.34476, 47.33628], [11.34584, 47.33626], [11.34744, 47.3361], [11.34913, 47.33579], [11.34952, 47.3358], [11.35025, 47.33586], [11.35089, 47.33605], [11.35159, 47.33607], [11.35195, 47.33597], [11.35221, 47.33568], [11.35253, 47.33555], [11.35569, 47.33554], [11.35805, 47.33524], [11.35929, 47.33504], [11.36175, 47.33517], [11.36255, 47.33518], [11.36325, 47.33531], [11.36501, 47.33588], [11.36617, 47.33614], [11.36697, 47.33645], [11.36708, 47.33657], [11.36719, 47.33697], [11.36736, 47.33723], [11.36739, 47.33739], [11.36747, 47.33744], [11.36756, 47.33744], [11.36759, 47.33741], [11.36759, 47.33721], [11.36755, 47.33643], [11.36751, 47.33637], [11.36727, 47.33614], [11.36683, 47.33595], [11.36627, 47.33581], [11.36615, 47.33569], [11.3661, 47.33553], [11.36619, 47.33513], [11.36626, 47.33504], [11.36659, 47.33474], [11.36665, 47.33463], [11.36665, 47.33446], [11.3667, 47.33436], [11.36677, 47.33431], [11.36685, 47.33434], [11.36685, 47.33452], [11.3667, 47.33497], [11.36668, 47.33509], [11.36671, 47.33517], [11.36687, 47.33519], [11.36716, 47.33507], [11.36749, 47.33499], [11.36823, 47.3351], [11.36845, 47.33502], [11.36852, 47.33487], [11.36857, 47.33455], [11.36862, 47.33439], [11.36879, 47.33435], [11.36898, 47.33449], [11.36933, 47.3348], [11.36945, 47.33494], [11.3701, 47.33517], [11.37025, 47.33534], [11.37033, 47.33557], [11.37109, 47.33616], [11.37117, 47.33638], [11.37116, 47.33689], [11.37124, 47.33712], [11.3718, 47.33731], [11.37182, 47.33724], [11.37161, 47.33713], [11.3715, 47.33693], [11.37154, 47.33664], [11.37173, 47.33633], [11.37198, 47.33612], [11.37226, 47.33597], [11.37248, 47.33594], [11.37296, 47.3361], [11.37327, 47.33614], [11.3736, 47.33626], [11.37442, 47.33633], [11.37497, 47.33645], [11.37521, 47.33656], [11.37532, 47.33655], [11.37558, 47.3365], [11.37633, 47.33645], [11.37669, 47.33647], [11.37724, 47.33669], [11.37783, 47.33682], [11.37804, 47.33685], [11.3781, 47.33691], [11.37821, 47.33693], [11.37829, 47.33697], [11.37861, 47.33697], [11.37926, 47.33725], [11.37988, 47.33732], [11.38038, 47.33727], [11.38083, 47.33734], [11.38103, 47.33742], [11.38113, 47.33751], [11.38123, 47.33755], [11.38252, 47.33748], [11.38298, 47.33737], [11.38366, 47.33746], [11.38436, 47.33743], [11.38506, 47.33761], [11.38532, 47.33759], [11.38573, 47.3377], [11.38637, 47.33779], [11.38704, 47.33766], [11.38737, 47.33767], [11.38757, 47.33763], [11.38862, 47.33779], [11.38907, 47.33789], [11.38964, 47.33784], [11.39087, 47.33795], [11.39186, 47.33778], [11.39238, 47.33744], [11.39279, 47.33737], [11.39325, 47.33747], [11.39344, 47.33745], [11.39381, 47.33754], [11.39403, 47.33753], [11.3944, 47.33741], [11.3947, 47.33738], [11.39491, 47.3373], [11.39562, 47.33725], [11.39611, 47.33723], [11.39637, 47.33725], [11.39681, 47.33722], [11.39704, 47.33717], [11.39787, 47.33712], [11.39849, 47.33693], [11.39919, 47.33702], [11.39992, 47.3369], [11.40091, 47.33693], [11.40178, 47.33682], [11.40218, 47.33666], [11.40316, 47.33668], [11.40437, 47.33656], [11.4051, 47.3366], [11.40634, 47.33651], [11.40763, 47.33653], [11.40785, 47.33658], [11.40807, 47.3366], [11.40832, 47.33669], [11.40943, 47.33681], [11.41049, 47.33678], [11.41071, 47.33672], [11.41147, 47.33669], [11.41162, 47.33667], [11.41178, 47.33667], [11.41188, 47.33671], [11.41192, 47.33678], [11.41187, 47.33688], [11.41125, 47.33714], [11.41041, 47.33734], [11.41034, 47.33739], [11.4104, 47.33745], [11.41069, 47.33747], [11.41132, 47.33761], [11.41202, 47.33763], [11.41236, 47.3376], [11.41316, 47.33768], [11.41355, 47.33767], [11.41415, 47.33752], [11.41441, 47.33748], [11.41541, 47.33748], [11.41587, 47.33737], [11.41642, 47.33742], [11.41686, 47.33749], [11.41738, 47.33742], [11.41786, 47.33729], [11.41813, 47.33709], [11.41863, 47.3369], [11.41882, 47.33686], [11.41914, 47.33669], [11.41953, 47.33659], [11.41998, 47.33655], [11.42055, 47.33633], [11.42128, 47.33608], [11.42167, 47.33601], [11.42182, 47.33587], [11.42344, 47.33547], [11.42401, 47.33525]];
      var map = window.map = new maplibregl.Map({
          container: 'map',
          zoom: 11,
          center: [11.365, 47.3465],
          style: {
              version: 8,
              sources: {
                  osm: {
                      type: 'raster',
                      tiles: ['https://a.tile.openstreetmap.org/{z}/{x}/{y}.png'],
                      tileSize: 256,
                      attribution: '&copy; OpenStreetMap Contributors',
                      maxzoom: 19
                  },
                  terrainSource: {
                      type: 'raster-dem',
                      url: 'https://demotiles.maplibre.org/terrain-tiles/tiles.json',
                      tileSize: 256
                  },
                  hillshadeSource: {
                      type: 'raster-dem',
                      url: 'https://demotiles.maplibre.org/terrain-tiles/tiles.json',
                      tileSize: 256
                  },
                  route: {
                      type: 'geojson',
                      data: {
                          type: 'Feature',
                          properties: {},
                          geometry: {
                              type: 'LineString',
                              coordinates
                          }
                      }
                  },
                  point: {
                      type: 'geojson',
                      data: {
                          type: 'Feature',
                          properties: {},
                          geometry: {
                              type: 'Point',
                              coordinates: coordinates[0]
                          }
                      }
                  }
              },
              layers: [
                  {
                      id: 'osm',
                      type: 'raster',
                      source: 'osm'
                  },
                  {
                      id: 'hills',
                      type: 'hillshade',
                      source: 'hillshadeSource',
                      layout: {'visibility': 'visible'},
                      paint: {'hillshade-shadow-color': '#473B24'}
                  },
                  {
                      id: 'route',
                      type: 'line',
                      source: 'route',
                      paint: {'line-color': '#007cbf', 'line-width': 5},
                      layout: {'line-cap': 'round', 'line-join': 'round'}
                  },
                  {
                      id: 'point',
                      source: 'point',
                      type: 'circle',
                      paint: {'circle-radius': 6, 'circle-color': '#007cbf', 'circle-stroke-width': 2, 'circle-stroke-color': 'white'}
                  }
              ],
              terrain: {
                  source: 'terrainSource',
                  exaggeration: 1
              }
          },
          maxZoom: 18,
          maxPitch: 85
      });

      map.addControl(new maplibregl.NavigationControl({
          visualizePitch: true,
          showZoom: true,
          showCompass: true
      }));
      
      const camera = {coord: null, altitude: 1000, distance: null};
      let start = null;
      const playtime = 30000;
      const route = turf.lineString(coordinates);

      var disableRoute = false;
      const animate = () => {
    start = start || Date.now();

    // calculate route progress and visualize a marker at the current progress
    const progress = Date.now() - start;
    const lngLat = turf.along(route, turf.lineDistance(route) * progress / playtime).geometry.coordinates;
    map.getSource('point').setData({type: 'Point', coordinates: lngLat});

    // let the camera follow the route
    const coord = maplibregl.MercatorCoordinate.fromLngLat(lngLat);
    const dx = coord.x - camera.coord.x, dy = coord.y - camera.coord.y;
    const delta = Math.hypot(dx, dy) - camera.distance;
    if (delta > 0) {
              //i don't know why, but lint wants this indentation
              const a = Math.atan2(dy, dx);
              camera.coord.x += Math.cos(a) * delta;
              camera.coord.y += Math.sin(a) * delta;
    }

    map.easeTo(map.calculateCameraOptionsFromTo(camera.coord.toLngLat(), camera.altitude, lngLat));

    if (progress < playtime && !disableRoute) requestAnimationFrame(animate);
};
      map.on('load', () => {
          // calculate camera startpoint
          //  - compute the direction of the first quater of the route
          //  - and place the camera in to opposite direction of this point
          const a = maplibregl.MercatorCoordinate.fromLngLat(coordinates[0]);
          const b = maplibregl.MercatorCoordinate.fromLngLat(turf.along(route, turf.lineDistance(route) / 4).geometry.coordinates);
          const dx = b.x - a.x, dy = b.y - a.y;
          camera.distance = Math.hypot(dx, dy);
          camera.coord = new maplibregl.MercatorCoordinate(a.x - dx, a.y - dy);
      
          map.on('click', (e) => {
              disableRoute = true;
              if (e.originalEvent.altKey) {
                  if (!this.first) {
                      this.first = map.transform.pointCoordinate(e.point, map.terrain);
                  } else {
                      const last = map.transform.pointCoordinate(e.point, map.terrain);
                      const co = map.calculateCameraOptionsFromTo(last.toLngLat(), last.z, this.first.toLngLat());
                      if (e.originalEvent.ctrlKey) {
                          map.jumpTo(co);
                      } else
                          map.flyTo(co);
                      this.first = null;
                  }
              }
          });

          map.flyTo(map.calculateCameraOptionsFromTo(camera.coord.toLngLat(), camera.altitude, coordinates[0]));
          setTimeout(() => animate(), 2000);
      });

   </script>

</body>

</html>