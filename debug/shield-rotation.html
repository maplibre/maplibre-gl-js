<!DOCTYPE html>
<html lang="en">

<head>
    <title>MapLibre GL JS debug page</title>
    <meta charset='utf-8'>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel='stylesheet' href='../dist/maplibre-gl.css' />
    <style>
        body {
            margin: 0;
            padding: 0;
        }

        html,
        body,
        #map {
            height: 100%;
        }
    </style>
</head>

<body>
    <div id='map'></div>

    <script src='../dist/maplibre-gl-dev.js'></script>

    <script>
        function loadShield(ctx, shield) {

            var scaleCanvas = document.createElement('canvas');
            var scaleCtx = scaleCanvas.getContext('2d');
            var imgData = scaleCtx.createImageData(shield.data.width, shield.data.height);

            for (i = 0; i < shield.data.data.length; i++) {
                imgData.data[i] = shield.data.data[i];
            }
            scaleCtx.putImageData(imgData, 0, 0);

            var scaleW = 80 / shield.data.width;
            var scaleH = 80 / shield.data.height;

            ctx.scale(scaleW, scaleH);
            ctx.drawImage(scaleCanvas, 0, 0);
            ctx.scale(1 / scaleW, 1 / scaleH);
        }

        var shields = {};
        var shieldImages = [];
        var shieldsLoaded = false;

        function initShields(map) {
            shieldImages = map.style.imageManager.images;

            shields['US:I'] = {
                backgroundImage: shieldImages.shield40_us_interstate,
                textColor: 'white',
                padding: {
                    left: 10,
                    right: 10,
                    top: 1,
                    bottom: 3
                },
            };

            shields['US:US'] = {
                backgroundImage: shieldImages.shield40_us_us,
                textColor: 'black',
                padding: {
                    left: 10,
                    right: 10,
                    top: 0,
                    bottom: 10
                },
            };

            shields['US:US:Historic'] = {
                backgroundImage: shieldImages.shield40_us_us,
                textColor: 'black',
                padding: {
                    left: 10,
                    right: 10,
                    top: 0,
                    bottom: 10
                },
                colorLighten: '#613214',
            };

            shields['US:PA'] = {
                backgroundImage: shieldImages.shield40_us_pa,
                textColor: 'black',
                padding: {
                    left: 10,
                    right: 10,
                    top: 0,
                    bottom: 10
                },
            };

            shields['US:PA:Turnpike'] = {
                backgroundImage: shieldImages.shield40_us_pa_turnpike,
                textColor: 'white',
                padding: {
                    left: 10,
                    right: 10,
                    top: 0,
                    bottom: 10
                },
            };

            shields['US:PA:Belt'] = {
                notext: true,
            };
        }

        function missingIconLoader(map, e) {

            var id = e.id;

            if (id === 'shield_') {
                return;
            }

            if (!shieldsLoaded) {
                initShields(map);
                shieldsLoaded = true;
            }

            var networkRef = id.split('_')[1];
            var networkRefParts = networkRef.split('=');
            var network = networkRefParts[0];
            var ref = networkRefParts[1];

            var width = 20;
            var height = 20;
            var colorLighten = null;

            var c = document.createElement('canvas');
            c.width = 80;
            c.height = 80;

            var scaleH = height / c.height;
            var scaleW = width / c.width;

            var ctx = c.getContext('2d');
            ctx.imageSmoothingQuality = 'high';
            ctx.mozImageSmoothingEnabled = true;
            ctx.webkitImageSmoothingEnabled = true;
            ctx.msImageSmoothingEnabled = true;
            ctx.imageSmoothingEnabled = true;
            ctx.textAlign = 'center';
            ctx.textBaseline = 'top';
            ctx.font = 'bold 16px Arial';

            if (shields[network] !== null) {
                var shieldDef = shields[network];
                var shield = shieldDef.backgroundImage;
                colorLighten = shieldDef.colorLighten;

                if (network === 'US:PA:Turnpike' && ref === '') {
                    shield = shieldImages.shield40_us_pa_turnpike_noref;
                }

                if (network === 'US:PA:Belt') {
                    switch (ref) {
                        case 'Red Belt':
                        default:
                            shield = shieldImages.shield40_us_pa_belt_red_2;
                            break;
                    }
                }

                if (shield === null) {
                    console.log('No shield defined for: ' + network + '=' + ref);
                    return;
                }

                loadShield(ctx, shield);

                if (shieldDef.notext !== true) {
                    ctx.fillStyle = shieldDef.textColor;

                    var padding = shieldDef.padding || {};
                    var padTop = padding.top || 0;
                    var padBot = padding.bottom || 0;
                    var padLeft = padding.left || 0;
                    var padRight = padding.right || 0;

                    var metrics = ctx.measureText(ref);
                    var textWidth = metrics.width;
                    var textHeight =
                        metrics.actualBoundingBoxAscent +
                        metrics.actualBoundingBoxDescent;

                    var desiredWidth = c.width - padLeft - padRight;
                    var scaleWidth = desiredWidth / textWidth;

                    var desiredHeight = c.height - padTop - padBot;
                    var scaleHeight = desiredHeight / textHeight;
                    var desiredRenderHeight = (c.height - padTop - padBot) / scaleHeight;
                    scaleHeight = Math.min(scaleWidth, scaleHeight);

                    var renderHeight = desiredHeight / scaleHeight;

                    var vBaselineOffset = (desiredRenderHeight - renderHeight) / 2;

                    ctx.scale(scaleWidth, scaleHeight);
                    ctx.fillText(ref,
                        (padLeft + 0.5 * desiredWidth) / scaleWidth,
                        (padTop) / scaleHeight - vBaselineOffset,
                        80);
                    ctx.scale(1 / scaleWidth, 1 / scaleHeight);
                }
            } else if (ref === '') {
                return;
            } else {
                switch (network) {
                    default: {
                        ctx.fillStyle = 'white';
                        ctx.fillRect(0, 0, 80, 80);
                        ctx.lineWidth = 8;
                        ctx.strokeStyle = 'black';
                        ctx.strokeRect(0, 0, 80, 80);
                    //        ctx.fillText(ref, width * 0.5, height * 0.58, width);
                    }
                }
            }

            var scaleCanvas = document.createElement('canvas');
            var scaleCtx = scaleCanvas.getContext('2d');
            scaleCtx.scale(scaleH, scaleW);
            scaleCtx.drawImage(c, 0, 0);

            if (colorLighten !== null) {
                scaleCtx.globalCompositeOperation = 'lighten';
                scaleCtx.fillStyle = colorLighten;
                scaleCtx.fillRect(0, 0, width * scaleW, height * scaleH);
                scaleCtx.globalCompositeOperation = 'destination-atop';
                scaleCtx.drawImage(c, 0, 0);
            }

            var imgData = scaleCtx.getImageData(0, 0, width, height);

            map.addImage(id, {
                width,
                height: width,
                data: imgData.data,
            });
        }

        var map = window.map = new maplibregl.Map({
            container: 'map',
            zoom: 10,
            center: [-86.0879, 39.8087],
            style: {
                'id': 'streets',
                'name': 'Americana',
                'zoom': 1,
                'pitch': 0,
                'center': [
                    0,
                    0
                ],
                'glyphs': 'https://fonts.openmaptiles.org/{fontstack}/{range}.pbf',
                'layers': [
                    {
                        'id': 'road_motorway',
                        'type': 'line',
                        'filter': [
                            'all',
                            [
                                '==',
                                'class',
                                'motorway'
                            ]
                        ],
                        'source': 'openmaptiles',
                        'source-layer': 'transportation'
                    },
                    {
                        'id': 'road_label',
                        'type': 'symbol',
                        'filter': [
                            'all',
                            [
                                '==',
                                'class',
                                'motorway'
                            ]
                        ],
                        'layout': {
                            'text-font': [
                                'Metropolis Light'
                            ],
                            'text-size': 20,
                            'text-field': [
                                'format',
                                [
                                    'image',
                                    'shield_US:I=70'
                                ],
                                ' ',
                                [
                                    'image',
                                    'shield_US:US=35'
                                ]
                            ],
                            'text-anchor': 'center',
                            'symbol-placement': 'line',
                            'text-rotate-to-line': false,
                            'text-pitch-alignment': 'viewport',
                        },
                        'source': 'openmaptiles',
                        'metadata': {},
                        'source-layer': 'transportation'
                    }
                ],
                'sprite': 'http://0.0.0.0:9966/debug/sprites/shield-rotation/sprite',
                'bearing': 0,
                'sources': {
                    'openmaptiles': {
                        'url': 'https://api.maptiler.com/tiles/v3/tiles.json?key=get_your_own_OpIi9ZULNHzrESv6T2vL',
                        'type': 'vector'
                    },
                },
                'version': 8
            },
            hash: true
        });

        map.addControl(new maplibregl.NavigationControl());

        map.on('styleimagemissing', function (e) {
            missingIconLoader(map, e);
        });

    </script>
</body>

</html>